# ============================================================================
# Supervisor Configuration: Desktop Environment Process Management
# ============================================================================
# Description:
#   Supervisor manages all long-running desktop services including:
#   - X11 display server (Xvfb)
#   - Window manager and desktop components (Openbox, LXPanel, PCManFM)
#   - VNC server for remote access
#   - Websocket VNC bridge
#   - HTTP reverse proxy
#
# Documentation: http://supervisord.org/
# ============================================================================

[supervisord]
# Run in foreground to keep container alive
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
# Set log level: debug, info, warn, error, critical
loglevel=info

# ============================================================================
# Service Definitions
# ============================================================================

# -------------------------------------------------
# [PRIORITY 10] Xvfb - Virtual Framebuffer
# -------------------------------------------------
# Purpose:
#   Creates a virtual X11 display server that renders to memory instead of
#   a physical monitor. All desktop GUI applications render to this display.
#
# Parameters:
#   - :0: Display number (exported as DISPLAY=:0 to child processes)
#   - screen 0: Virtual screen (1920x1080x24bit by default)
#
# Environment variables are injected via parent shell:
#   - %(ENV_WIDTH)s, %(ENV_HEIGHT)s: Set by startup.sh
[program:xvfb]
command=/usr/bin/Xvfb :0 -screen 0 %(ENV_WIDTH)sx%(ENV_HEIGHT)sx24
priority=10
autostart=true
autorestart=true
startsecs=2
# Logs
stdout_logfile=/var/log/supervisor/xvfb.out.log
stderr_logfile=/var/log/supervisor/xvfb.err.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

# -------------------------------------------------
# [PRIORITY 20] Openbox - Window Manager
# -------------------------------------------------
# Purpose:
#   Manages window layout, decorations, and user interactions.
#   Essential for proper desktop window handling.
#
# Startup delay: Reduced to 1 second (sufficient for Xvfb readiness)
[program:openbox]
command=/bin/bash -c "sleep 1 && /usr/bin/openbox"
environment=DISPLAY=":0"
priority=20
autostart=true
autorestart=true
startsecs=2
stdout_logfile=/var/log/supervisor/openbox.out.log
stderr_logfile=/var/log/supervisor/openbox.err.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

# -------------------------------------------------
# [PRIORITY 21] LXPanel - Task Bar & Application Menu
# -------------------------------------------------
# Purpose:
#   Provides the taskbar, system tray, and application launcher menu.
#   Allows users to see open windows and launch applications.
#
# Startup delay: Reduced to 2 seconds (optimized for faster startup)
[program:lxpanel]
command=/bin/bash -c "sleep 2 && /usr/bin/lxpanel --profile LXDE"
environment=DISPLAY=":0"
priority=21
autostart=true
autorestart=true
startsecs=2
stdout_logfile=/var/log/supervisor/lxpanel.out.log
stderr_logfile=/var/log/supervisor/lxpanel.err.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

# -------------------------------------------------
# [PRIORITY 22] PCManFM - File Manager & Desktop
# -------------------------------------------------
# Purpose:
#   Manages the desktop (wallpaper, icons) and provides file browsing.
#   Renders desktop icons and handles file operations.
#
# Startup delay: Reduced to 2.5 seconds (optimized for faster startup)
# Flags:
#   - --desktop: Render desktop with icons
#   - --profile LXDE: Use LXDE configuration profile
[program:pcmanfm]
command=/bin/bash -c "sleep 2.5 && /usr/bin/pcmanfm --desktop --profile LXDE"
environment=DISPLAY=":0"
priority=22
autostart=true
autorestart=true
startsecs=2
stdout_logfile=/var/log/supervisor/pcmanfm.out.log
stderr_logfile=/var/log/supervisor/pcmanfm.err.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

# -------------------------------------------------
# [PRIORITY 30] x11vnc - VNC Server
# -------------------------------------------------
# Purpose:
#   Exposes the X11 display over the VNC protocol (port 5900).
#   Allows remote users to view and interact with the desktop.
#
# Parameters:
#   - -display :0: Connect to our virtual display
#   - -rfbauth: Use password authentication file
#   - -forever: Keep accepting connections after client disconnects
#   - -shared: Allow multiple simultaneous connections
#   - -rfbport 5900: Listen on standard VNC port
#
# Startup delay: Reduced to 3 seconds (optimized for faster readiness)
[program:x11vnc]
command=/bin/bash -c "sleep 3 && /usr/bin/x11vnc -display :0 -rfbauth /root/.vnc/passwd -forever -shared -rfbport 5900"
priority=30
autostart=true
autorestart=true
startsecs=2
stdout_logfile=/var/log/supervisor/x11vnc.out.log
stderr_logfile=/var/log/supervisor/x11vnc.err.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

# -------------------------------------------------
# [PRIORITY 40] Websockify - VNC over WebSocket
# -------------------------------------------------
# Purpose:
#   Bridges VNC protocol to WebSocket, enabling browser-based access.
#   Allows users to connect via noVNC in a web browser without VNC client.
#
# Parameters:
#   - --web=/opt/novnc: Serve noVNC web interface
#   - 6080: WebSocket listening port
#   - localhost:5900: Target x11vnc server
#
# Use cases:
#   - Access desktop from restricted networks (no VNC port access)
#   - No client software installation required
#   - Works on mobile devices with web browsers
[program:websockify]
command=/usr/local/bin/websockify --web=/opt/novnc 6080 localhost:5900
priority=40
autostart=true
autorestart=true
startsecs=2
stdout_logfile=/var/log/supervisor/websockify.out.log
stderr_logfile=/var/log/supervisor/websockify.err.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

# -------------------------------------------------
# [PRIORITY 50] Nginx - HTTP Reverse Proxy
# -------------------------------------------------
# Purpose:
#   Provides HTTP access (port 80) to the WebSocket noVNC service.
#   Simplifies access: http://localhost instead of :6080 port.
#
# Configuration:
#   - Listens on port 80 (standard HTTP)
#   - Proxies requests to websockify (localhost:6080)
#   - Upgrades connections to WebSocket
#
# Use case:
#   Users can access the desktop at: http://docker-host/
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
priority=50
autostart=true
autorestart=true
startsecs=2
stdout_logfile=/var/log/supervisor/nginx.out.log
stderr_logfile=/var/log/supervisor/nginx.err.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

# ============================================================================
# Configuration Notes
# ============================================================================
#
# Service Dependencies (Priority Order):
#   1. Xvfb (Priority 10) - Virtual display must exist first
#   2. Openbox (Priority 20) - Window manager initializes
#   3. LXPanel (Priority 21) - Taskbar
#   4. PCManFM (Priority 22) - File manager & desktop
#   5. x11vnc (Priority 30) - VNC server exposes the display
#   6. Websockify (Priority 40) - WebSocket bridge
#   7. Nginx (Priority 50) - HTTP proxy
#
# Log Files:
#   All service logs are written to /var/log/supervisor/
#   Review logs if a service fails to start:
#     docker exec <container> cat /var/log/supervisor/<service>.err.log
#
# Troubleshooting:
#   - x11vnc won't connect: Check Xvfb is running
#   - Browser can't load: Verify Nginx is running and listening on port 80
#   - Black screen: Ensure PCManFM and Openbox started correctly
#   - Performance issues: Increase RESOLUTION if container has resources
